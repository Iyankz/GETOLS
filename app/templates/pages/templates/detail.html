{% extends "layouts/base.html" %}

{% block title %}{{ template.name }} - GETOLS{% endblock %}

{% block page_title %}Template Details{% endblock %}

{% block header_actions %}
{% if user and user.can_manage_templates() %}
<a href="/templates/{{ template.id }}/edit" class="btn btn-primary">
    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
    </svg>
    Edit Template
</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="card-title-group">
            <h2 class="card-title">{{ template.name }}</h2>
            {% if template.is_default %}
            <span class="badge badge-primary">Default</span>
            {% endif %}
            {% if template.is_active %}
            <span class="badge badge-success">Active</span>
            {% else %}
            <span class="badge badge-danger">Disabled</span>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        {% if template.description %}
        <p class="template-description mb-4">{{ template.description }}</p>
        {% endif %}
        
        <div class="detail-grid">
            <div class="detail-section">
                <h3>Profile Configuration</h3>
                <dl class="detail-list">
                    <dt>Line Profile</dt>
                    <dd><code>{{ template.line_profile }}</code></dd>
                    
                    <dt>Service Profile</dt>
                    <dd><code>{{ template.service_profile }}</code></dd>
                    
                    <dt>VLAN</dt>
                    <dd><span class="badge badge-info">{{ template.vlan }}</span></dd>
                    
                    <dt>Service Port Start</dt>
                    <dd>{{ template.service_port_start or 'Auto' }}</dd>
                </dl>
            </div>
            
            <div class="detail-section">
                <h3>Usage Statistics</h3>
                <dl class="detail-list">
                    <dt>Total ONUs Registered</dt>
                    <dd><strong>{{ template.usage_count }}</strong> ONUs</dd>
                    
                    <dt>Created By</dt>
                    <dd>{{ template.created_by or 'System' }}</dd>
                    
                    <dt>Created</dt>
                    <dd>{{ template.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                    
                    <dt>Last Updated</dt>
                    <dd>{{ template.updated_at.strftime('%Y-%m-%d %H:%M') if template.updated_at else '-' }}</dd>
                </dl>
            </div>
        </div>
        
        {% if template.additional_params %}
        <div class="detail-section mt-4">
            <h3>Additional Parameters</h3>
            <pre class="code-block">{{ template.additional_params|tojson(indent=2) }}</pre>
        </div>
        {% endif %}
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h2 class="card-title">Generated Commands Preview</h2>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Sample commands that will be generated when using this template:</p>
        
        <pre class="code-block"># ONU Registration Command
interface gpon-olt_1/x/y
  ont add [ONU_ID] sn-auth "[SERIAL_NUMBER]" omci ont-lineprofile-id {{ template.line_profile }} ont-srvprofile-id {{ template.service_profile }} desc "[CUSTOMER_NAME]"
  
# Service Port Configuration  
service-port [PORT_ID] vport [ONU_ID]/0/1 vlan {{ template.vlan }}

# Native VLAN Setting
onu vlan-filter [ONU_ID] priority 0 filter-mode pass vlan {{ template.vlan }}</pre>
    </div>
</div>

{% if user and user.can_manage_templates() %}
<div class="card mt-4">
    <div class="card-header">
        <h2 class="card-title">Actions</h2>
    </div>
    <div class="card-body">
        <div class="action-buttons-large">
            <a href="/templates/{{ template.id }}/edit" class="btn btn-primary">Edit Template</a>
            
            {% if not template.is_default %}
            <form action="/templates/{{ template.id }}/set-default" method="post" style="display:inline;">
                <button type="submit" class="btn btn-outline">Set as Default</button>
            </form>
            {% endif %}
            
            {% if template.usage_count == 0 %}
            <button 
                class="btn btn-danger"
                onclick="confirmDelete('/templates/{{ template.id }}/delete', 'Delete template {{ template.name }}?')"
            >
                Delete Template
            </button>
            {% else %}
            <button class="btn btn-danger" disabled title="Cannot delete - template is in use">
                Delete Template (In Use)
            </button>
            {% endif %}
        </div>
        
        {% if template.usage_count > 0 %}
        <p class="text-warning mt-3">
            <svg class="inline-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            This template is currently used by {{ template.usage_count }} ONU(s) and cannot be deleted.
        </p>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}
