{% extends "layouts/base.html" %}

{% block title %}ONU Monitoring - GETOLS{% endblock %}

{% block page_title %}ONU Monitoring{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Real-time ONU Monitoring</h3>
        <div class="card-header-actions">
            <select id="olt-filter" class="form-select" style="width: auto;" onchange="filterByOLT(this.value)">
                <option value="">All OLTs</option>
                {% for olt in olts %}
                <option value="{{ olt.id }}" {% if selected_olt and selected_olt.id == olt.id %}selected{% endif %}>
                    {{ olt.name }}
                </option>
                {% endfor %}
            </select>
            {% if selected_olt %}
            <button class="btn btn-outline btn-sm"
                    hx-post="/onu/monitoring/refresh"
                    hx-target="#monitoring-table"
                    hx-include="#olt-filter"
                    hx-indicator="#refresh-loading">
                <span id="refresh-loading" class="htmx-indicator">Refreshing...</span>
                <span>Refresh</span>
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body" id="monitoring-table">
        {% if onus %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Serial Number</th>
                        <th>Name</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>RX Power</th>
                        <th>TX Power</th>
                        <th>Signal Quality</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for onu in onus %}
                    <tr>
                        <td><code>{{ onu.serial_number }}</code></td>
                        <td>{{ onu.name or '-' }}</td>
                        <td><code>{{ onu.full_location }}</code></td>
                        <td>
                            {% if onu.status.value == 'online' %}
                            <span class="badge badge-success">Online</span>
                            {% elif onu.status.value == 'offline' %}
                            <span class="badge badge-danger">Offline</span>
                            {% elif onu.status.value == 'low_signal' %}
                            <span class="badge badge-warning">Low Signal</span>
                            {% else %}
                            <span class="badge badge-secondary">Unknown</span>
                            {% endif %}
                        </td>
                        <td class="signal-{{ onu.signal_quality }}">{{ onu.rx_power_display }}</td>
                        <td>{{ onu.tx_power_display }}</td>
                        <td>
                            {% if onu.signal_quality == 'good' %}
                            <span class="signal-indicator signal-good">●●●●</span>
                            {% elif onu.signal_quality == 'fair' %}
                            <span class="signal-indicator signal-fair">●●●○</span>
                            {% elif onu.signal_quality == 'poor' %}
                            <span class="signal-indicator signal-poor">●●○○</span>
                            {% elif onu.signal_quality == 'critical' %}
                            <span class="signal-indicator signal-critical">●○○○</span>
                            {% else %}
                            <span class="signal-indicator signal-unknown">○○○○</span>
                            {% endif %}
                        </td>
                        <td>{{ onu.last_seen|datetime if onu.last_seen else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No ONUs to monitor. Select an OLT to view its ONUs.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function filterByOLT(oltId) {
    if (oltId) {
        window.location.href = '/onu/monitoring?olt_id=' + oltId;
    } else {
        window.location.href = '/onu/monitoring';
    }
}
</script>

<style>
.signal-good { color: var(--success); }
.signal-fair { color: var(--warning); }
.signal-poor { color: #f97316; }
.signal-critical { color: var(--danger); }
.signal-unknown { color: var(--text-muted); }

.signal-indicator {
    font-size: 0.75rem;
    letter-spacing: 2px;
}
</style>
{% endblock %}
