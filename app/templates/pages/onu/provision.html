{% extends "layouts/base.html" %}

{% block title %}Provision ONU - GETOLS{% endblock %}

{% block page_title %}Provision ONU{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Register New ONU</h3>
    </div>
    <div class="card-body">
        {% if error %}
        <div class="alert alert-error">
            <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>{{ error }}</span>
        </div>
        {% endif %}
        
        <form method="post" action="/onu/provision">
            <input type="hidden" name="olt_id" value="{{ olt.id }}">
            <input type="hidden" name="pon_port" value="{{ pon_port }}">
            <input type="hidden" name="onu_id" value="{{ onu_id }}">
            <input type="hidden" name="serial_number" value="{{ serial_number }}">
            
            <div class="form-section">
                <h4 class="form-section-title">ONU Information</h4>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">OLT</span>
                        <span class="info-value">{{ olt.name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">PON Port</span>
                        <span class="info-value"><code>{{ pon_port }}</code></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ONU ID</span>
                        <span class="info-value">{{ onu_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Serial Number</span>
                        <span class="info-value"><code>{{ serial_number }}</code></span>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h4 class="form-section-title">Configuration</h4>
                
                <div class="form-group">
                    <label for="name" class="form-label">ONU Name *</label>
                    <input type="text" id="name" name="name" class="form-input" 
                           value="{{ form_data.name if form_data else '' }}"
                           placeholder="e.g., Customer Name - Location" required>
                </div>
                
                <div class="form-group">
                    <label for="template_id" class="form-label">Provisioning Template</label>
                    <select id="template_id" name="template_id" class="form-select" onchange="loadTemplateValues(this.value)">
                        <option value="">-- Select Template (or configure manually) --</option>
                        {% for tmpl in templates %}
                        <option value="{{ tmpl.id }}" 
                                data-line="{{ tmpl.line_profile }}"
                                data-service="{{ tmpl.service_profile }}"
                                data-vlan="{{ tmpl.vlan }}"
                                {% if default_template and default_template.id == tmpl.id %}selected{% endif %}>
                            {{ tmpl.name }} {% if tmpl.is_default %}(Default){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-section">
                <h4 class="form-section-title">Profile Configuration</h4>
                <p class="text-muted mb-3">These values are auto-filled from the selected template. You can override them if needed.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="line_profile" class="form-label">Line Profile</label>
                        <input type="text" id="line_profile" name="line_profile" class="form-input" 
                               value="{{ form_data.line_profile if form_data else (default_template.line_profile if default_template else '') }}"
                               placeholder="e.g., line-profile-1">
                    </div>
                    
                    <div class="form-group">
                        <label for="service_profile" class="form-label">Service Profile</label>
                        <input type="text" id="service_profile" name="service_profile" class="form-input" 
                               value="{{ form_data.service_profile if form_data else (default_template.service_profile if default_template else '') }}"
                               placeholder="e.g., service-profile-1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vlan" class="form-label">VLAN</label>
                        <input type="number" id="vlan" name="vlan" class="form-input" 
                               value="{{ form_data.vlan if form_data else (default_template.vlan if default_template else '') }}"
                               min="1" max="4094" placeholder="e.g., 100">
                    </div>
                    
                    <div class="form-group">
                        <label for="service_port" class="form-label">Service Port (Optional)</label>
                        <input type="number" id="service_port" name="service_port" class="form-input" 
                               value="{{ form_data.service_port if form_data else '' }}"
                               placeholder="Auto-assign if empty">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Register ONU
                </button>
                <a href="/onu/discovery?olt_id={{ olt.id }}" class="btn btn-outline">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
function loadTemplateValues(templateId) {
    const select = document.getElementById('template_id');
    const option = select.options[select.selectedIndex];
    
    if (templateId && option.dataset.line) {
        document.getElementById('line_profile').value = option.dataset.line;
        document.getElementById('service_profile').value = option.dataset.service;
        document.getElementById('vlan').value = option.dataset.vlan;
    }
}

// Load default template values on page load
document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('template_id');
    if (select.value) {
        loadTemplateValues(select.value);
    }
});
</script>

<style>
.form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.form-section-title {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.info-item {
    background-color: var(--bg-darker);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
}

.info-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.info-value {
    font-weight: 500;
}

.mb-3 {
    margin-bottom: 0.75rem;
}
</style>
{% endblock %}
